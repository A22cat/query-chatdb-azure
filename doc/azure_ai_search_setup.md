## Azure AI Searchのインデックスとフィールドの設定

1.  Azureポータルで「Azure AI Search」を検索し、「AI Search」を選択します。
2.  作成したサービス名(＝名前)を選択します。
3.  左メニューから「インデックス」を選択し、インデックスを作成 (例：`chat-history-index`)します。
4.  作成したインデックス (例：`chat-history-index`)を選択し、フィールド(タブ)の「+フィールドの追加」を選択します。
5.  右側のサイドバーのインデックスフィールドの設定画面で次に必要なフィールド名（`id`, `question`, `generated_sql`, `summary`, `timestamp`）を設定します。
6.  「保存」ボタンを選択します。

**Azure AI Search インデックス名**：`chat-history-index`

| フィールド名       | 種類 (Data Type)          | 取得可能<br>(Retrievable) | フィルター<br>可能<br>(Filterable) | 並べ替え<br>可能<br>(Sortable) | Facetable      | 検索可能<br>(Searchable) | 検索可能の<br>“アナライザー”         | その他               | 備考                  |
|--------------------|----------------------------|-----------------------------|------------------------------------|-------------------------------|----------------|---------------------------|--------------------------------------|----------------------|----------------------|
| id                 | Edm.String                 | 〇                          | 〇                                 | 〇                            | 〇              | ✕                         |                                      |                      |               |
| question           | Edm.String                 | 〇                          | 〇                                 | 〇                            | ✕ (任意)        | 〇                         | 日本語-Microsoft                    |                      |              |
| generated_sql      | Edm.String                 | 〇                          | 〇                                 | 〇 (任意)                     | ✕ (任意)        | 〇 (任意)                 | Standard-Lucene（デフォルト）       |                      |               |
| summary            | Edm.String                 | 〇                          | 〇 (任意)                          | 〇 (任意)                     | ✕ (任意)        | 〇                         | 日本語-Microsoft                    |                      |              |
| timestamp          | Edm.DateTimeOffset         | 〇                          | 〇                                 | 〇                            | ✕ (任意)        | ー                         |                                      |                      |              |
| summary_vector     | Collection(Edm.Single)     | 〇                          | ー                                 | ー                            | ー              | 〇                         |                                      | ディメンション：1536 | ※1でベクトルプロファイルの設定を確認 |
|

## ※1：ベクトルフィールド（`summary_vector`）に「リスト形式の数値配列」を設定し、ベクトルプロファイルを構成する詳細な手順。

- フィールド名：`summary_vector`
- 種類：`Collection(Edm.Single)`

## ●ベクトルフィールドの作成手順
1.  Azureポータルで「Azure AI Search」を検索し、「AI Search」を選択します。
2.  左メニューから作成した「インデックス」(例：`chat-history-index`)を選択します。
3.  フィールド(タブ)の追加画面で、以下の設定を行います。


### ▼1.ベクトルフィールド設定例

| 項目                     | 設定値例／説明                                                                 |
|--------------------------|------------------------------------------------------------------------------|
| フィールド名             | `summary_vector`                                                             |
| 種類                     | `Collection(Edm.Single)`                                                     |
| 取得可能                 | `true`（検索結果で取得できるようにする）                                      |
| 検索可能                 | `true`（ベクトル検索対象とする）                                              |
| フィルター可能           | `false`（ベクトルフィールドは不可）                                           |
| 並べ替え可能             | `false`（ベクトルフィールドは不可）                                           |
| ファセット可能           | `false`（ベクトルフィールドは不可）                                           |
| ディメンション           | `1536`（例: OpenAIの `text-embedding-ada-002` や `text-embedding-3-small` の次元数）は1536 |
| ベクトル(検索)プロファイル | 後述の「ベクトル(検索)プロファイル」で作成した名称（例: `my-vector-profile`）      |


### ▼2.ベクトル検索プロファイルの設定方法
4. 右サイドバーのインデックスフィールド画面でベクトル検索プロファイルの「作成」ボタンを選択
5. ベクトルプロファイルの名前：`my-vector-profile-01`（例: my-vector-profile、vector-profile-1748932868930）を設定
6. 「新しいベクターアルゴリズムの作成」を選択
7. ベクトルアルゴリズム画面で次の項目を設定

```
例:アルゴリズムのパラメータを設定（デフォルト値でも可）
ベクトルアルゴリズム
アルゴリズム名:`hnsw-01` (例：hnsw-1、vector-config-1748933060962)
種類: hnsw

Kindパラメーター
- m(双方向リンク数(m)): 4
- efConstruction: 400
- efSearch: 500
- metric(類似性メトリック): cosine
```

8.アルゴリズムを選択：hnsw-01（例: HNSW）
9.プロファイルを保存
10.「保存」ボタンを選択。


- ベクトル化：設定なし (※1)
- 圧縮：設定なし。圧縮構成の設定は必須ではありませんが、大規模な運用を視野に入れる場合は設定を強く推奨します。 (※2)

### ▼3.ベクトルフィールドの構成例（JSON形式）
json
```
{
  "name": "summary_vector",
  "type": "Collection(Edm.Single)",
  "searchable": true,
  "retrievable": true,
  "filterable": false,
  "sortable": false,
  "facetable": false,
  "dimensions": 1536,
  "vectorSearchProfile": "my-vector-profile-01"
}
```

### ▼4.ベクトル検索プロファイルの構成例（JSON形式）
json
```
"vectorSearch": {
  "algorithms": [
    {
      "name": "hnsw-01",
      "kind": "hnsw",
      "hnswParameters": {
        "m": 4,
        "efConstruction": 400,
        "efSearch": 500,
        "metric": "cosine"
      }
    }
  ],
  "profiles": [
    {
      "name": "my-vector-profile-01",
      "algorithm": "hnsw-1"
    }
  ]
}
```

### 5. まとめ
この構成で、summary_vector フィールドに「リスト形式の数値配列（例: [0.1, -0.2, 0.3, ...]）」をアップロードできるようになります。  




## 参考：Azure AI Searchのベクトル化と圧縮に関して

#### ※1 ベクトル化の設定が不要な理由：

現在の「Qnect」のアーキテクチャでは、アプリケーション側（Pythonコード内）でAzure OpenAIのEmbeddingモデルを使用してテキスト（要約など）をベクトル化し、その生成されたベクトルデータをAzure AI Searchに送信しています。  
Azure AI Searchの「ベクトル化」機能（統合ベクトル化）は、インデックスにドキュメントを追加する際に、Azure AI Search自身が指定されたAIモデル（Azure OpenAIなど）を呼び出してベクトルを生成するためのものです。  
今回は既にベクトルを計算済みなので、Azure AI Search側で再度ベクトル化を行う必要はありません。`summary_vector` フィールドには、アプリケーションから送られてきたベクトルデータをそのまま格納するだけで大丈夫です。

---

#### ※2 圧縮構成の設定を推奨する理由：

ベクトル検索では、大量のベクトルデータをメモリにロードして計算を行うため、データ量が増えるとコストとクエリの応答時間に影響が出ます。圧縮構成（ベクトル量子化）は、ベクトルの精度を少しだけ犠牲にすることで、以下の大きなメリットをもたらします。

- ストレージコストの削減: ベクトルのデータサイズが小さくなります。
- クエリパフォーマンスの向上: 計算対象のデータが小さくなるため、検索が高速になります。
- インデックス作成時間の短縮: インデックス構築も高速化されます。

ハッカソンのデモレベルでは効果を体感しにくいかもしれませんが、実運用では非常に重要な機能です。

---

#### 推奨される設定内容：

もし設定する場合、以下の内容をお勧めします。

- 圧縮名: `summary-vector-compressor` （分かりやすい名前であれば何でも構いません）
- Kind: スカラーのビン分割 (Scalar Quantization)  
  - これは現在、最も一般的で効果的な圧縮方法の一つです。バイナリのビン分割は特定のモデルやユースケース向けです。
- 元のベクトルを使用して再スコア付けする (Rerank with original vector): **ON（有効）**  
  - これは非常に重要な設定です。この設定をONにすると、まず圧縮された軽量なベクトルで高速に候補を絞り込み（例: 上位100件）、その候補に対してだけ、元の高精度なベクトルを使って再度スコアリング（順位付け）を行います。これにより、検索速度と精度の両方を高いレベルで維持できます。
- 切り捨てディメンション と 元のベクトル解像度を保持する:  
  通常、`Rerank with original vector` をONにする場合は、これらはデフォルト設定のままで問題ありません。特に「元のベクトル解像度を保持する」はONにしておくことで、再スコア付けが可能になります。
